<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AB Serve - Flagship QA</title>
    <link rel="stylesheet" href="style.css">
    <!-- Dependencies -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <header class="app-header-floating" id="floating-header">
        <div class="header-row">
            <!-- Left: Meta Info -->
            <div class="header-meta-group">
                <div class="meta-line">
                    <span id="header-date-top" class="header-date-text">--/--/----</span>
                </div>
                <div class="meta-line">
                    <div id="digital-clock" class="digital-clock">00:00</div>
                    <button onclick="AppState.toggleTheme()" class="btn-minimal-link"
                        style="color: inherit; font-size: 1.1rem; padding: 0;">ğŸŒ“</button>
                </div>
            </div>

            <!-- Right: Logo -->
            <div class="logo-container">
                <img src="media/logo.png" alt="Logo" class="logo-small"
                    onerror="this.src='https://via.placeholder.com/80x30?text=AB+Serve'">
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Unified Mission Info Badge (Moved here) -->
        <div id="mission-badge" class="mission-info-badge" onclick="AppState.toggleHeader()"
            style="margin-bottom: 15px;">
            <span id="badge-text"></span>
            <span id="badge-icon">â–¼</span>
        </div>

        <!-- Separated Collapsible Info Section -->
        <div id="header-collapsible" class="collapsible-section">
            <section class="card-flagship" style="padding: 15px;">
                <div class="input-group">
                    <label>Inspector Name (Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´)</label>
                    <input type="text" id="inspector-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´ (Name)">
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Shift From (Ù…Ù†)</label><input type="time" id="shift-from"></div>
                    <div class="input-group"><label>To (Ø¥Ù„Ù‰)</label><input type="time" id="shift-to"></div>
                </div>
                <div class="input-group">
                    <label>Vendor (Ø§Ù„Ù…ÙˆØ±Ø¯)</label>
                    <div id="vendor-container">
                        <select id="vendor" onchange="AppState.handleVendorChange(this.value)">
                            <option value="">Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…ÙˆØ±Ø¯ (Select Vendor...)</option>
                            <option value="One Tech">One Tech</option>
                            <option value="Martur Fompak">Martur Fompak</option>
                            <option value="Gentherm Vietnam">Gentherm Vietnam</option>
                            <option value="Voltaira">Voltaira</option>
                            <option value="Other">ÙŠØ¯ÙˆÙŠ...</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>Client (Ø§Ù„Ø¹Ù…ÙŠÙ„)</label>
                    <div id="client-container">
                        <input type="text" id="client" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Client Name)">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Ref (Ø§Ù„Ù…Ø±Ø¬Ø¹)</label><input type="text" id="ref-number"
                            list="ref-list" oninput="AppState.handleReferenceChange()" placeholder="Ref #"></div>
                    <div class="input-group"><label>Designation (Ø§Ù„ØªØ¹ÙŠÙŠÙ†)</label><input type="text" id="part-name"
                            placeholder="Part Name">
                    </div>
                </div>
            </section>
        </div>

        <main class="app-content">
            <!-- Counter Section (Control Pods) -->
            <section class="card-flagship">
                <!-- FLAGSHIP SCANNER BUTTON -->
                <button class="btn-scanner-flagship" onclick="AppState.triggerPrimaryScanner()">
                    <span>ğŸ“· SMART SCAN (ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)</span>
                </button>

                <div id="dynamic-fields-container">
                    <div class="empty-state">Select Vendor to Start</div>
                </div>

                <div class="input-row" style="margin-top: 25px;">
                    <!-- Neumorphic Pod: OK -->
                    <div class="counter-box-neumorphic">
                        <span class="pod-label">QTY OK (ØµØ§Ù„Ø­)</span>
                        <div id="ok-count" class="pod-value" style="color: var(--accent);">00</div>
                        <div class="pod-controls">
                            <button class="btn-icon" onclick="AppState.adjustCounter('ok', -1)">âˆ’</button>
                            <button class="btn-icon" onclick="AppState.adjustCounter('ok', 1)">+</button>
                        </div>
                    </div>
                    <!-- Neumorphic Pod: NOK -->
                    <div class="counter-box-neumorphic">
                        <span class="pod-label" style="color: var(--nok-red);">QTY NOK (Ø¹ÙŠØ¨)</span>
                        <div id="nok-count" class="pod-value" style="color: var(--nok-red);">00</div>
                        <div class="pod-controls">
                            <button class="btn-icon"
                                style="background:var(--nok-red); font-size: 0.8rem; letter-spacing: 0.05em;"
                                disabled>DEFECTS</button>
                        </div>
                    </div>
                </div>

                <!-- Highly Prominent Add Defect Button -->
                <button class="btn-action-highlight" onclick="AppState.addDefectRow()">
                    <span>+ Ø¥Ø¶Ø§ÙØ© Ø¹ÙŠØ¨ (Add Defect)</span>
                </button>

                <div id="defect-list" style="margin-top: 15px;"></div>
            </section>

            <!-- Media Section -->
            <section class="card-flagship">
                <div class="input-group">
                    <label>DEFECT PHOTOS (ØµÙˆØ± Ø§Ù„Ø¹ÙŠÙˆØ¨)</label>
                    <input type="file" id="defects-images" accept="image/*" multiple>
                    <div id="image-preview" style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;"></div>
                </div>
                <div class="input-group">
                    <label>COMMENTS (Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)</label>
                    <textarea id="comments" rows="2" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø©... (Note)"></textarea>
                </div>
                <button id="add-to-report" class="btn btn-success full-width"
                    style="border-radius: 14px; height: 56px;">
                    Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Save Record)
                </button>
            </section>

            <!-- History Section -->
            <section class="history-section" id="reportToExport">
                <!-- HIDDEN EXPORT HEADER (Specialized for Image) -->
                <div id="export-header-section" class="export-only-header" style="display: none;">
                    <div class="export-header-grid">
                        <div class="header-item"><strong>Inspector (Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´):</strong> <span
                                id="exp-inspector">-</span></div>
                        <div class="header-item"><strong>Date (Ø§Ù„ØªØ§Ø±ÙŠØ®):</strong> <span id="exp-date">-</span></div>
                        <div class="header-item"><strong>Shift (Ø§Ù„ÙˆØ±Ø¯ÙŠØ©):</strong> <span id="exp-shift">-</span></div>
                        <div class="header-item"><strong>Vendor (Ø§Ù„Ù…ÙˆØ±Ø¯):</strong> <span id="exp-vendor">-</span></div>
                    </div>
                </div>

                <div class="list-header">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (History)</h3>
                    <button id="toggle-list-btn" class="btn-minimal-link" onclick="AppState.toggleHistoryDisplay()">
                        Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ <span id="chevron-icon">â€º</span>
                    </button>
                </div>

                <!-- TABLE HEADER FOR GRID -->
                <div class="grid-table-header">
                    <span class="grid-col">NÂ°</span>
                    <span class="grid-col">Reference</span>
                    <span class="grid-col">N.Etiquette</span>
                    <span class="grid-col">Lot Number</span>
                    <span class="grid-col">Qty OK</span>
                    <span class="grid-col">Qty NOK</span>
                    <span class="grid-col">Reworked</span>
                    <span class="grid-col action-col">Actions</span>
                </div>

                <div id="scanned-list">
                    <!-- History cards with dynamic 'card-danger' will be injected here -->
                </div>

                <div class="dashboard-summary-row">
                    <span style="opacity: 0.8; font-size: 0.9rem;">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (TOTAL CHECKED):</span>
                    <span id="total-qty-val"
                        style="font-size: 1.4rem; font-weight: 800; font-family: 'Readex Pro';">0</span>
                </div>
            </section>
        </main>

        <footer style="padding: 16px; display: flex; gap: 12px; margin-bottom: 20px;">
            <button id="gen-img" class="btn btn-primary" style="flex: 1; border-radius: 14px; background: #6366f1;">ğŸ–¼ï¸
                Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© (Image)</button>
            <button id="gen-pdf" class="btn btn-primary" style="flex: 1; border-radius: 14px;">ØªÙ‚Ø±ÙŠØ± PDF (PDF)</button>
            <button id="share-whatsapp" class="btn btn-whatsapp" style="flex: 1; border-radius: 14px;">ÙˆØ§ØªØ³Ø§Ø¨
                (WhatsApp)</button>
        </footer>
    </div>

    <!-- Scanner Modal Overlay -->
    <div id="scanner-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div
                style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0; font-family: 'Readex Pro'; font-weight: 700;">QR/BARCODE SCANNER</h3>
                <button onclick="ScannerManager.closeModal()" class="btn-minimal-link"
                    style="font-size: 1.5rem;">âœ•</button>
            </div>
            <div class="camera-preview">
                <div id="reader"></div>
                <div class="scanner-hud">
                    <div class="hud-corner hud-top-left"></div>
                    <div class="hud-corner hud-top-right"></div>
                    <div class="hud-corner hud-bottom-left"></div>
                    <div class="hud-corner hud-bottom-right"></div>
                    <div class="hud-scan-line"></div>
                </div>
            </div>
            <div class="modal-controls">
                <p id="scanner-status"
                    style="text-align: center; font-size: 0.9rem; opacity: 0.7; margin-bottom: 10px;">
                    Position code within frame
                </p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    <datalist id="ref-list"></datalist>

    <!-- High-Fidelity Final Report Template (Bilingual) -->
    <div id="final-report-template" class="report-container" style="position: absolute; left: -9999px; top: -9999px;">
        <div class="report-inner">
            <header class="rep-header">
                <div class="rep-header-left">
                    <div class="rep-meta-field"><strong>Date :</strong> <span id="rep-date-val">--/--/----</span></div>
                    <div class="rep-meta-field"><strong>Horaire : DE :</strong> <span id="rep-shift-start">06:00</span>
                        <strong>Ã€ :</strong> <span id="rep-shift-end">14:00</span>
                    </div>
                    <div class="rep-meta-field"><strong>Nom du ContrÃ´leur :</strong> <span
                            id="rep-inspector-val">-</span></div>
                    <div class="rep-meta-field"><strong>Site client :</strong> <span id="rep-client-val">-</span></div>
                </div>
                <div class="rep-header-center">
                    <div class="rep-upper-meta">
                        <div class="rep-meta-field"><strong>Fournisseur :</strong> <span id="rep-vendor-val">-</span>
                        </div>
                        <div class="rep-meta-field"><strong>RÃ©fÃ©rence :</strong> <span id="rep-ref-val">-</span></div>
                        <div class="rep-meta-field"><strong>DÃ©signation :</strong> <span id="rep-part-val">-</span>
                        </div>
                    </div>
                </div>
                <div class="rep-header-right">
                    <div class="rep-logo-box">
                        <div class="rep-title-tag">RAPPORT AB SERVE FREE ZONE</div>
                        <img src="media/logo.png" alt="AB Serve Logo" class="rep-logo-img">
                    </div>
                </div>
            </header>

            <div class="rep-table-section">
                <!-- Main Header Structure -->
                <div id="rep-main-grid-header" class="rep-grid-header-top">
                    <div class="header-main-title left-section">DÃ©tails de la prestation / Service details:</div>
                    <div class="header-main-title right-section">Liste des dÃ©fauts / List of defects</div>
                </div>
                <!-- Dynamic Column Headers -->
                <div id="rep-dynamic-column-headers" class="rep-grid-row sub-header">
                    <!-- Injected via JS -->
                </div>
                <!-- Data Rows Container -->
                <div id="rep-grid-rows-container">
                    <!-- Injected via JS -->
                </div>
            </div>

            <footer class="rep-footer">
                <div class="rep-footer-top">
                    <div class="rep-comments-box">
                        <strong>Commentaires :</strong>
                        <p id="rep-comments-val">Pas de notes supplÃ©mentaires / Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</p>
                    </div>
                </div>
                <div class="rep-evidence-section">
                    <strong>Photos / Evidence :</strong>
                    <div id="rep-gallery" class="rep-image-grid"></div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Export Preview Modal -->
    <div id="export-preview-modal" class="preview-modal" style="display: none;">
        <div class="preview-content">
            <div class="preview-header">
                <h3>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Report Preview)</h3>
            </div>
            <div class="preview-body">
                <div id="preview-image-container"></div>
            </div>
            <div class="preview-footer">
                <button id="preview-edit-btn" class="btn btn-secondary">ØªØ¹Ø¯ÙŠÙ„ (Edit)</button>
                <button id="preview-save-btn" class="btn btn-success">Ø­ÙØ¸ (Save)</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <!-- Modern Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="modal-overlay" style="display: none;">
        <div class="confirm-card">
            <div class="confirm-icon">â“</div>
            <h3 id="confirm-title">ØªØ£ÙƒÙŠØ¯ (Confirm)</h3>
            <p id="confirm-msg"></p>
            <div class="confirm-actions">
                <button id="confirm-yes" class="btn btn-success">Ù†Ø¹Ù… (YES)</button>
                <button id="confirm-no" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡ (NO)</button>
            </div>
        </div>
    </div>

</body>

</html>