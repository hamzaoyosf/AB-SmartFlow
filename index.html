<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AB Serve - Flagship QA</title>
    <link rel="stylesheet" href="style.css">
    <!-- Dependencies -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
    <header class="app-header-floating" id="floating-header">
        <div class="header-row">
            <!-- Left: Meta Info -->
            <div class="header-meta-group">
                <div class="meta-line">
                    <span id="header-date-top" class="header-date-text">--/--/----</span>
                </div>
                <div class="meta-line">
                    <div id="digital-clock" class="digital-clock">00:00</div>
                    <button onclick="AppState.toggleTheme()" class="btn-minimal-link"
                        style="color: inherit; font-size: 1.1rem; padding: 0;">๐</button>
                </div>
            </div>

            <!-- Right: Logo -->
            <div class="logo-container">
                <img src="media/logo.png" alt="Logo" class="logo-small"
                    onerror="this.src='https://via.placeholder.com/80x30?text=AB+Serve'">
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Unified Mission Info Badge (Moved here) -->
        <div id="mission-badge" class="mission-info-badge" onclick="AppState.toggleHeader()"
            style="margin-bottom: 15px;">
            <span id="badge-text"></span>
            <span id="badge-icon">โผ</span>
        </div>

        <!-- Separated Collapsible Info Section -->
        <div id="header-collapsible" class="collapsible-section">
            <section class="card-flagship" style="padding: 15px;">
                <div class="input-group">
                    <label>Inspector Name (ุงุณู ุงูููุชุด)</label>
                    <input type="text" id="inspector-name" placeholder="ุงุณู ุงูููุชุด (Name)">
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Shift From (ูู)</label><input type="time" id="shift-from"></div>
                    <div class="input-group"><label>To (ุฅูู)</label><input type="time" id="shift-to"></div>
                </div>
                <div class="input-group">
                    <label>Vendor (ุงูููุฑุฏ)</label>
                    <div id="vendor-container">
                        <select id="vendor" onchange="AppState.handleVendorChange(this.value)">
                            <option value="">ุงุฎุชุงุฑ ุงูููุฑุฏ (Select Vendor...)</option>
                            <option value="One Tech">One Tech</option>
                            <option value="Martur Fompak">Martur Fompak</option>
                            <option value="Gentherm Vietnam">Gentherm Vietnam</option>
                            <option value="Voltaira">Voltaira</option>
                            <option value="Other">ูุฏูู...</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>Client (ุงูุนููู)</label>
                    <div id="client-container">
                        <input type="text" id="client" placeholder="ุงุณู ุงูุนููู (Client Name)">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Ref (ุงููุฑุฌุน)</label><input type="text" id="ref-number"
                            list="ref-list" oninput="AppState.handleReferenceChange()" placeholder="Ref #"></div>
                    <div class="input-group"><label>Designation (ุงูุชุนููู)</label><input type="text" id="part-name"
                            placeholder="Part Name">
                    </div>
                </div>
            </section>
        </div>

        <main class="app-content">
            <!-- Counter Section (Control Pods) -->
            <section class="card-flagship">
                <!-- FLAGSHIP SCANNER BUTTON -->
                <button class="btn-scanner-flagship" onclick="AppState.triggerPrimaryOCR()">
                    <span>๐ท SMART SCAN (ุชูุนูู ุงููุงููุฑุง)</span>
                </button>

                <div id="dynamic-fields-container">
                    <div class="empty-state">Select Vendor to Start</div>
                </div>

                <div class="input-row" style="margin-top: 25px;">
                    <!-- Neumorphic Pod: OK -->
                    <div class="counter-box-neumorphic">
                        <span class="pod-label">QTY OK (ุตุงูุญ)</span>
                        <div id="ok-count" class="pod-value" style="color: var(--accent);">00</div>
                        <div class="pod-controls">
                            <button class="btn-icon" onclick="AppState.adjustCounter('ok', -1)">โ</button>
                            <button class="btn-icon" onclick="AppState.adjustCounter('ok', 1)">+</button>
                        </div>
                    </div>
                    <!-- Neumorphic Pod: NOK -->
                    <div class="counter-box-neumorphic">
                        <span class="pod-label" style="color: var(--nok-red);">QTY NOK (ุนูุจ)</span>
                        <div id="nok-count" class="pod-value" style="color: var(--nok-red);">00</div>
                        <div class="pod-controls">
                            <button class="btn-icon"
                                style="background:var(--nok-red); font-size: 0.8rem; letter-spacing: 0.05em;"
                                disabled>DEFECTS</button>
                        </div>
                    </div>
                </div>

                <!-- Highly Prominent Add Defect Button -->
                <button class="btn-action-highlight" onclick="AppState.addDefectRow()">
                    <span>+ ุฅุถุงูุฉ ุนูุจ (Add Defect)</span>
                </button>

                <div id="defect-list" style="margin-top: 15px;"></div>
            </section>

            <!-- Media Section -->
            <section class="card-flagship">
                <div class="input-group">
                    <label>DEFECT PHOTOS (ุตูุฑ ุงูุนููุจ)</label>
                    <input type="file" id="defects-images" accept="image/*" multiple>
                    <div id="image-preview" style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;"></div>
                </div>
                <div class="input-group">
                    <label>COMMENTS (ุงูููุงุญุธุงุช)</label>
                    <textarea id="comments" rows="2" placeholder="ุฃุถู ููุงุญุธุฉ... (Note)"></textarea>
                </div>
                <button id="add-to-report" class="btn btn-success full-width"
                    style="border-radius: 14px; height: 56px;">
                    ุญูุธ ุงูุชูุฑูุฑ (Save Record)
                </button>
            </section>

            <!-- History Section -->
            <section class="history-section">
                <div class="list-header">
                    <h3>ุณุฌู ุงูุนูููุงุช</h3>
                    <button id="toggle-list-btn" class="btn-minimal-link" onclick="AppState.toggleHistoryDisplay()">
                        ุนุฑุถ ุงููู <span id="chevron-icon">โบ</span>
                    </button>
                </div>

                <div id="scanned-list">
                    <!-- History cards with dynamic 'card-danger' will be injected here -->
                </div>

                <div class="dashboard-summary-row">
                    <span style="opacity: 0.8; font-size: 0.9rem;">ุงูุนุฏุฏ ุงูุฅุฌูุงูู (TOTAL CHECKED):</span>
                    <span id="total-qty-val"
                        style="font-size: 1.4rem; font-weight: 800; font-family: 'Readex Pro';">0</span>
                </div>
            </section>
        </main>

        <footer style="padding: 16px; display: flex; gap: 12px; margin-bottom: 20px;">
            <button id="gen-pdf" class="btn btn-primary" style="flex: 1; border-radius: 14px;">ุชูุฑูุฑ PDF (PDF)</button>
            <button id="share-whatsapp" class="btn btn-whatsapp" style="flex: 1; border-radius: 14px;">ูุงุชุณุงุจ
                (WhatsApp)</button>
        </footer>
    </div>

    <!-- OCR Modal Overlay -->
    <div id="ocr-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div
                style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0; font-family: 'Readex Pro'; font-weight: 700;">OCR SCANNER (ูุงุณุญ ุงููุตูุต)</h3>
                <button onclick="ScannerManager.closeModal()" class="btn-minimal-link"
                    style="font-size: 1.5rem;">โ</button>
            </div>
            <div class="camera-preview">
                <video id="ocr-video" autoplay playsinline muted></video>
                <div class="scanner-hud">
                    <div class="hud-corner hud-top-left"></div>
                    <div class="hud-corner hud-top-right"></div>
                    <div class="hud-corner hud-bottom-left"></div>
                    <div class="hud-corner hud-bottom-right"></div>
                    <div class="hud-scan-line"></div>
                </div>
            </div>
            <div id="ocr-loading"
                style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 10; flex-direction: column; align-items: center; justify-content: center;">
                <div class="loading-spinner"></div>
                <p style="color: var(--primary-blue); font-weight: 700; font-family: 'Inter';">ANALYZING...</p>
            </div>
            <div class="modal-controls">
                <button class="btn btn-primary full-width" style="height: 60px; border-radius: 16px;"
                    onclick="ScannerManager.capture()">ุชุญููู (CAPTURE & PROCESS)</button>
                <canvas id="ocr-canvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    <datalist id="ref-list"></datalist>

    <script src="app.js"></script>
</body>

</html>